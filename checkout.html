<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - DC Creation</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="adminlogin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Play&display=swap" rel="stylesheet">
    <style>
        /* Main container styling */
        main {
            padding: 30px 50px;
        }

        /* Navbar general styling */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #333;
            padding: 10px 20px;
            position: relative;
            /* Ensure it doesn't overlap with other content */
        }

        .logo {
            margin-right: auto;
            /* Ensures logo takes space to avoid overlap */
        }

        .navbar ul {
            list-style: none;
            display: flex;
            gap: 15px;
            padding: 0;
            margin: 0;
        }


        .navbar li {
            position: relative;
        }

        /* Hamburger Icon */
        .hamburger {
            display: none;
            font-size: 30px;
            cursor: pointer;
            color: white;
            margin-left: 20px;
            /* Add margin to the left */
        }

        /* Side Navigation Styling */
        .sidenav {
            height: auto;
            width: 0;
            position: fixed;
            z-index: 1000;
            top: 0;
            right: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: auto;
            border-radius: 10px;
        }

        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }


        .sidenav a:hover {
            color: #f1f1f1;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        /* Responsive Navbar and Sidenav */
        @media (max-width: 768px) {
            .navbar ul {
                display: none;
            }

            .hamburger {
                display: block;
                /* Show hamburger in small screen */
            }

            .navbar {
                padding: 10px;
                /* Adjust padding for smaller screens */
            }
        }

        /* Mobile-specific adjustments */
        @media (max-width: 480px) {
            .sidenav a {
                font-size: 18px;
            }
        }


        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }

        h1,
        h2 {
            text-align: center;
        }

        form {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: block;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input[type="number"],
        input[type="email"],
        input[type="text"],
        input[type="tel"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            color: white;
            background-color: #28a745;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }

        #accountCreation,
        #passwordField,
        #billingAddress {
            margin-top: 20px;
        }

        /* Order Summary Styling */
        #orderSummary {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #orderSummary h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-item img {
            margin-right: 15px;
            border-radius: 4px;
        }

        #grandTotal {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Header Section -->
    <header>
        <div class="top-bar">
            <p>+91 9737833333 | info@abcd.com</p>
        </div>
        <nav class="navbar">
            <div class="logo">
                <img alt="Logo" id="logoImage">
            </div>  
            <span class="hamburger" onclick="openNav()">&#9776;</span>
            <ul id="navbar-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="aboutus.html">About Us</a></li>
                <li><a href="mainproduct.html">Collections</a></li>
                <li><a href="contactus.html">Contact Us</a></li>
            </ul>
            <li id="user-nav">
                <a href="#" id="login-link">Login</a> <!-- Default Login Link -->
            </li>
            <li><a href="cart.html" id="cartIcon">
                    <i class="fa fa-shopping-cart"></i> <span id="cartCount">0</span>
                </a></li>
        </nav>
    </header>
    <!-- Side Navigation for Mobile -->
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="index.html">Home</a>
        <a href="aboutus.html">About Us</a>
        <a href="mainproduct.html">Collections</a>
        <a href="contactus.html">Contact Us</a>
        <li id="user-nav">
            <a href="#" id="login-link">Login</a> <!-- Default Login Link -->
        </li>
        <li><a href="cart.html" id="cartIcon">
                <i class="fa fa-shopping-cart"></i> <span id="cartCount">0</span>
            </a></li>

    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
          <span class="close" id="close-modal">&times;</span>
          <div class="form-container">
            <div class="form-header">
              <button id="login-btn" class="active">Login</button>
              <button id="register-btn">Register</button>
            </div>
            <form id="login-form" class="active">
              <h2>Login</h2>
              <label for="login-email">Email</label>
              <input type="email" id="login-email" placeholder="Enter your email" required />
              <label for="login-password">Password</label>
              <input type="password" id="login-password" placeholder="Enter your password" required />
              <button type="button" id="login-submit" class="submit-btn">Login</button>
              <p><a href="#" id="forgot-password-link">Forgot Password?</a></p>
            </form>
            <form id="register-form">
              <h2>Register</h2>
              <label for="register-name">Name</label>
              <input type="text" id="register-name" placeholder="Enter your name" required />
              <label for="register-email">Email</label>
              <input type="email" id="register-email" placeholder="Enter your email" required />
              <label for="register-password">Password</label>
              <input type="password" id="register-password" placeholder="Create a password" required />
              <button type="button" id="register-submit" class="submit-btn">Register</button>
            </form>
          </div>
        </div>
      </div>

      <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
          <span class="close" id="close-forgot-password-modal">&times;</span>
          <h2>Reset Password</h2>
      
          <!-- Forgot Password Form -->
          <form id="forgot-password-form">
            <label for="reset-email">Email</label>
            <input type="email" id="reset-email" placeholder="Enter your email" required />
            <button type="button" id="reset-password-submit" class="submit-btn">Send Reset Link</button>
          </form>
        </div>
      </div>
    



    <h1>Checkout</h1>

    <!-- Order Summary Section -->
    <section id="orderSummary">
        <h2>Order Summary</h2>
        <div id="orderItemsContainer"></div>
        <div id="orderTotals">
            <p>Total Amount: <span id="totalAmount">₹0.00</span></p>
            <p>GST (5%): <span id="gstAmount">₹0.00</span></p>
            <p>Grand Total: <span id="grandTotalAmount">₹0.00</span></p>
        </div>
    </section>

    <section id="checkout">
        <form id="checkoutForm">
            <!-- Shipping Information -->
            <div id="shippingInfo">
                <h2>Shipping Address</h2>
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="fullName" required>

                <label for="address">Address</label>
                <input type="text" id="address" name="address" required>

                <label for="city">City</label>
                <input type="text" id="city" name="city" required>

                <label for="postalCode">Postal Code</label>
                <input type="number" id="postalCode" name="postalCode" required>

                <label for="country">Country</label>
                <input type="text" id="country" name="country" required>

                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" required>

                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="Enter your email">
            </div>

            <!-- Billing Information -->
            <div id="billingInfo">
                <h2>Billing Address</h2>
                <label>
                    <input type="checkbox" id="sameAsShipping" checked> Same as Shipping
                </label>
                <div id="billingAddress" style="display: none;">
                    <label for="billingAddressField">Billing Address</label>
                    <input type="text" id="billingAddressField" name="billingAddress">
                </div>
            </div>

            <div id="paymentInfo">
                <h2>Payment Method</h2>
                <label>
                    <input type="radio" name="paymentMethod" value="phonepe" checked> PhonePe
                </label>
                <label>
                    <input type="radio" name="paymentMethod" value="cod"> Cash on Delivery
                </label>
            </div>

            <!-- Place Order Button -->
            <button type="submit" id="placeOrderButton">Place Order</button>
        </form>
    </section>
    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/9737833333" class="whatsapp-float" target="_blank">
        <img src="WhatsApp_icon.png" alt="WhatsApp" />
    </a>

    <footer>
        <div class="footer">
            <div class="row">
                <a href="#"><i class="fa fa-facebook"></i></a>
                <a href="#"><i class="fa fa-instagram"></i></a>
                <a href="#"><i class="fa fa-youtube"></i></a>
                <a href="#"><i class="fa fa-twitter"></i></a>
            </div>
            <div class="row">
                <ul>
                    <li><a href="#">Contact us</a></li>
                    <li><a href="#">Our Services</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms & Conditions</a></li>
                    <li><a href="#">Career</a></li>
                </ul>
            </div>
            <div class="row">
                <p>&copy; <span id="year"></span> DC Creation. All rights reserved.</p>
                <p>Website by Deepak-VDC</p>
            </div>
        </div>
    </footer>

    <script src="myaccountlogin.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userId = localStorage.getItem("userId");
            if (!userId) {
                console.error("User ID is missing in localStorage.");
                alert("You must log in before proceeding.");
                window.location.href = "login.html"; // Redirect to login if not logged in
                return;
            } else {
                console.log("Retrieved userId from localStorage:", userId);
            }


            // Fetch user profile details
            async function fetchUserProfile() {
                const userId = localStorage.getItem("userId");
                console.log("Retrieved userId from localStorage:", userId);

                if (!userId || userId === "USER_ID_VALUE") {
                    console.error("Invalid or missing userId in localStorage.");
                    return;
                }

                const apiUrl = `https://dc-1-fqlb.onrender.com/user/${userId}`;
                console.log('Requesting user profile from:', apiUrl);

                try {
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    if (!response.ok) {
                        const errorMessage = await response.text();
                        throw new Error(`Error fetching user data: ${errorMessage}`);
                    }

                    const userData = await response.json();
                    console.log('User profile:', userData);
                    return userData;
                } catch (error) {
                    console.error('Error fetching user profile:', error);
                }
            }



            // Pre-fill the form with user data
            async function prefillShippingForm() {
                if (!userId) {
                    alert("User not logged in. Redirecting to login page.");
                    window.location.href = "login.html";
                    return;
                }

                const userProfile = await fetchUserProfile(userId);

                if (userProfile) {
                    document.getElementById("fullName").value = userProfile.fullName || "";
                    document.getElementById("address").value = userProfile.deliveryAddress || "";
                    document.getElementById("billingAddressField").value = userProfile.billingAddress || "";
                    document.getElementById("email").value = userProfile.email || "";
                    console.log("Form fields populated with user data");
                }
            }

            await prefillShippingForm();

            // Order Summary Rendering
            function renderOrderSummary() {
                const orderItemsContainer = document.getElementById('orderItemsContainer');
                orderItemsContainer.innerHTML = '';

                let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
                let totalAmount = 0;

                cartItems.forEach(item => {
                    const itemTotal = Number(item.price) * item.quantity;
                    totalAmount += itemTotal;

                    const itemRow = document.createElement('div');
                    itemRow.className = 'summary-item';
                    itemRow.innerHTML = `
                <img src="${item.mainImage}" alt="${item.title}" width="50" height="50">
                <div>
                    <h3>${item.title}</h3>
                    <p>Quantity: ${item.quantity}</p>
                    <p>Price: ₹${Number(item.price).toFixed(2)}</p>
                    <p>Total: ₹${itemTotal.toFixed(2)}</p>
                </div>
            `;
                    orderItemsContainer.appendChild(itemRow);
                });

                // Calculate GST and Grand Total
                const gstAmount = totalAmount * 0.5;
                const grandTotal = totalAmount + gstAmount;

                document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;
                document.getElementById('gstAmount').textContent = `₹${gstAmount.toFixed(2)}`;
                document.getElementById('grandTotalAmount').textContent = `₹${grandTotal.toFixed(2)}`;
            }

            renderOrderSummary();

            // Handle Form Submission
            const checkoutForm = document.getElementById("checkoutForm");

            checkoutForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                // Gather form data
                const formData = new FormData(checkoutForm);
                const formObject = {};
                formData.forEach((value, key) => {
                    formObject[key] = value;
                });

                // Retrieve cart items from localStorage
                const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
                if (cartItems.length === 0) {
                    alert("Your cart is empty. Please add items to proceed.");
                    return;
                }

                // Add required details to the order object
                formObject.userId = userId;
                formObject.items = cartItems;
                formObject.paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

                if (!formObject.paymentMethod) {
                    alert("Please select a payment method.");
                    return;
                }

                function formatPhoneNumber(phone) {
                    // Remove non-numeric characters
                    const cleaned = phone.replace(/\D/g, '');
                    // Add country code if missing (assuming default is India: +91)
                    if (!cleaned.startsWith('91')) {
                        return `+91${cleaned}`;
                    }
                    return `+${cleaned}`;
                }

                // Example usage
                formObject.phone = formatPhoneNumber(formObject.phone);

                try {
    // Send order details to the backend
    const response = await fetch("https://dc-1-fqlb.onrender.com/checkout", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(formObject),
    });

    if (response.ok) {
        const result = await response.json();
        console.log("Order placement response:", result); // Debug log

        if (result.orderId) {
            // Display success message and redirect
            alert("Order placed successfully!");
            localStorage.removeItem("cart"); // Clear cart
            checkoutForm.reset();
            window.location.href = `order_confirmation.html?orderId=${result.orderId}`; // Pass order ID to confirmation page
        } else {
            console.error("Order ID is missing in the response:", result);
            alert("Order placement succeeded, but confirmation is not possible. Contact support.");
        }
    } else {
        const result = await response.json();
        alert("Error: " + result.message);
    }
} catch (error) {
    console.error("Error placing order:", error);
    alert("An error occurred while placing your order. Please try again later.");
}

            });
        });

        window.addEventListener("load", () => {
            const userId = localStorage.getItem("userId");
            console.log("Retrieved userId from localStorage:", userId);

            if (!userId) {
                console.error("Invalid or missing userId in localStorage.");
                // Handle the missing userId case (e.g., redirect to login)
            } else {
                // Proceed with using the userId
            }
        });


    </script>

    <script src="script.js"></script>
    <script src="myaccountlogin.js"></script>
</body>

</html>